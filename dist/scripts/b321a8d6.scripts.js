"use strict";angular.module("sheetApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngTouch","ngAnimate","ngDialog","chieffancypants.loadingBar","angularFileUpload"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/sheet/:characterId?",{templateUrl:"views/sheet.html",controller:"SheetCtrl"}).when("/statblock/:characterId",{templateUrl:"views/statblock.html",controller:"StatBlockCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/sandbox",{templateUrl:"views/sandbox.html",controller:"SandboxCtrl"}).otherwise({redirectTo:"/"})}]).config(["$httpProvider",function(a){var b=function(a,b){return{responseError:function(c){return b.path("/login"),a.reject(c)}}};b.$inject=["$q","$location"],a.interceptors.push(b)}]).factory("user",["$cookieStore",function(a){return a.get("sheetuser")||{}}]).value("cache",{}).filter("range",function(){return function(a,b){b=parseInt(b);for(var c=0;b>c;c++)a.push(c);return a}}).filter("ordinal",function(){return function(a){var b="th";return 1===a?b="st":2===a&&(b="nd"),a+b}}).filter("expandGender",function(){return function(a){var b={F:"Female",M:"Male"};return b[a]}}).filter("expandSize",function(){return function(a){var b={T:"Tiny",S:"Small",M:"Medium",L:"Large",H:"Huge"};return b[a]}}).filter("orDash",function(){return function(a){return a||"&mdash;"}}).filter("skillName",function(){return function(a){return a.replace(/(\d)$/,"").replace(/([a-z])([A-Z])/g,"$1 $2")}}).run(["$rootScope","$location","user","cache",function(a,b,c,d){var e=["/login","/logout","/statblock","/sandbox"],f=function(a){return _.find(e,function(b){return a.match(b)})};a.$on("$routeChangeStart",function(){f(b.url())||c.id||(d.redirect=b.url(),b.path("/login"))}),a.$on("$routeChangeSuccess",function(b,c){c.$$route&&c.$$route.controller&&(a.controllerName=c.$$route.controller)})}]),angular.module("sheetApp").controller("MainCtrl",["$scope","user","Character",function(a,b,c){a.user=b,a.filterActive=function(a){return"archived"!==a.status&&"deleted"!==a.status},a.characters=c.query({q:{"user.id":b.id,status:{"@$ne":"deleted"}},f:{user:1,name:1,modified:1,race:1,level:1,status:1}},function(){angular.forEach(a.characters,function(a){a.id=a._id,a.level||(a.level="Unspecified class/level"),a.resourceUrl="/api/v1/characters/"+a._id})}),a.archiveCharacter=function(a){a.status="archived",a.saveOrUpdate()},a.restoreCharacter=function(a){a.status="active",a.saveOrUpdate()},a.deleteCharacter=function(a,b){var c=b.target;"Delete"===c.innerHTML?c.innerHTML="Confirm?":(a.status="deleted",a.saveOrUpdate())}}]),angular.module("sheetApp").controller("SheetCtrl",["$scope","$rootScope","$routeParams","$timeout","$http","$location","ngDialog","user","Character",function(a,b,c,d,e,f,g,h,i){function j(){a.sheet.$setPristine(),a.saveText="All Changes Saved",d(function(){a.saveText="",m=!1},2500)}function k(){m=!1}function l(b,c,d,e,f){"add"===b&&(c={},d.push(c)),a.dialog={mode:b,item:c,items:d},void 0!==f&&(a.dialog.spellData=a.spellData,"sp"!==f&&(a.dialog.item.level=f)),"sp"===f&&(a.dialog.spellLike=!0),g.open({template:e,controller:"DialogCtrl",scope:a})}a.user=h,a.saveText="";var m=!1;if(h.id||f.path("/login"),c.characterId)a.character=i.getById(c.characterId);else{a.character=new i,a.character.user=h,a.character.spells=[];for(var n=0;9>=n;n++)a.character.spells[n]={};a.character.$resolved=!0}e.get("data/spell_names.json").success(function(b){a.spellNames=b}),e.get("data/spells.json").success(function(b){a.spellData=b}),a.spellSchools=["Abjuration","Conjuration","Divination","Enchantment","Evocation","Illusion","Necromancy","Transmutation","Universal"],a.saveCharacter=function(){a.saveText="Saving...",a.character.name||(a.character.name="Unnamed Character"),a.character.modified=new Date,a.character.saveOrUpdate(j,j,k,k)};var o=function(b,c){c.$resolved&&a.sheet.$valid&&!m&&(m=!0,a.saveCharacter())};a.$watch("character",_.debounce(o,2500),!0),a.scrollTo=function(a,b){b.preventDefault(),window.scrollTo(0,document.getElementById(a).offsetTop)},a.addMelee=function(){angular.isArray(a.character.melee)||(a.character.melee=[]),a.character.melee.push({})},a.addRanged=function(){angular.isArray(a.character.ranged)||(a.character.ranged=[]),a.character.ranged.push({})},a.addAcItem=function(){a.character.ac||(a.character.ac={}),angular.isArray(a.character.ac.items)||(a.character.ac.items=[]),a.character.ac.items.push({})},a.confirmRemoveDialog=function(a,b){l("remove",a,b,"views/dialog/removeItem.html")},a.featDialog=function(b,c){angular.isArray(a.character.feats)||(a.character.feats=[]),l(b,c,a.character.feats,"views/dialog/feat.html")},a.saDialog=function(b,c){angular.isArray(a.character.specialAbilities)||(a.character.specialAbilities=[]),l(b,c,a.character.specialAbilities,"views/dialog/specialAbility.html")},a.traitDialog=function(b,c){angular.isArray(a.character.traits)||(a.character.traits=[]),l(b,c,a.character.traits,"views/dialog/trait.html")},a.gearDialog=function(b,c){angular.isArray(a.character.gear)||(a.character.gear=[]),l(b,c,a.character.gear,"views/dialog/gear.html")},a.spellDialog=function(b,c,d){a.character.spells||(a.character.spells=[]),a.character.spells[b]||(a.character.spells[b]={}),angular.isArray(a.character.spells[b].slotted)||(a.character.spells[b].slotted=[]),l(c,d,a.character.spells[b].slotted,"views/dialog/spell.html",b)},a.spellLikeDialog=function(b,c){a.character.spellLikes||(a.character.spellLikes=[]),l(b,c,a.character.spellLikes,"views/dialog/spell.html","sp")},a.prepLeft=function(a){return a.prepared||(a.prepared=0),a.cast||(a.cast=0),a.prepared-a.cast},a.modifier=function(b){var c,d,e="temp"+b.charAt(0).toUpperCase()+b.slice(1);return a.character&&a.character.$resolved&&a.character.abilities&&(c=a.character.abilities[e]?a.character.abilities[e]:a.character.abilities[b],c&&(d=Math.floor((parseInt(c,10)-10)/2),d>=0&&(d="+"+d))),d},a.debugStuff=function(){console.log(a.sheet.$valid)},a.showCharacterResource=function(){console.log(a.character)}}]),angular.module("sheetApp").controller("LoginCtrl",["$scope","user",function(a,b){a.user=b}]),angular.module("sheetApp").controller("DialogCtrl",["$scope","ngDialog",function(a,b){a.items=a.dialog.items,a.item=a.dialog.item,a.mode=a.dialog.mode,a.deleteText="Delete",a.remove=function(){if("Delete"===a.deleteText)a.deleteText="Confirm?";else{var c=a.items.indexOf(a.item);c>-1&&a.items.splice(c,1),b.close()}},a.confirmRemove=function(){var c=a.items.indexOf(a.item);a.items.splice(c,1),b.close()},a.close=function(){b.close()},a.dismiss=function(){var c=a.items.indexOf(a.item);c>-1&&a.items.splice(c,1),b.close()},a.spellData&&a.$watch("item.name",function(b){a.spellData[b]&&(a.description=a.spellData[b].fulltext,a.item.school=a.spellData[b].school,a.item.subschool=a.spellData[b].subschool)},!0),a.prepare=function(){a.item.prepared++},a.cast=function(){a.item.cast<a.item.prepared&&a.item.cast++},a.clearCounts=function(){a.item.prepared=0,a.item.cast=0},a.toggleMark=function(){a.item.marked=!a.item.marked},a.tPrepared=function(){return a.dialog.spellLike?"Per Day":"Prepared"},a.tCast=function(){return a.dialog.spellLike?"Used":"Cast"},a.toggleAtWill=function(){a.item.atWill=!a.item.atWill}}]),angular.module("sheetApp").controller("SandboxCtrl",["$scope","$http","user","$fileUploader",function(a,b,c,d){a.thing="Stuff",a.user=c;var e=a.uploader=d.create({scope:a,url:"/upload"});e.bind("afteraddingfile",function(a,b){console.info("After adding a file",b)}),e.bind("afteraddingall",function(a,b){console.info("After adding all files",b)}),e.bind("beforeupload",function(a,b){console.info("Before upload",b)}),e.bind("progress",function(a,b,c){console.info("Progress: "+c,b)}),e.bind("success",function(a,b,c,d){console.info("Success",b,c,d)}),e.bind("cancel",function(a,b,c){console.info("Cancel",b,c)}),e.bind("error",function(a,b,c,d){console.info("Error",b,c,d)}),e.bind("complete",function(a,b,c,d){console.info("Complete",b,c,d)}),e.bind("progressall",function(a,b){console.info("Total progress: "+b)}),e.bind("completeall",function(a,b){console.info("Complete all",b)})}]),angular.module("sheetApp").controller("StatBlockCtrl",["$scope","$routeParams","$location","Character",function(a,b,c,d){b.characterId?a.character=d.getById(b.characterId):c.path(""),a.filterSkills=function(a){var b={};return angular.forEach(a,function(a,c){a.total&&(b[c]=a)}),b},a.filterMoney=function(a){var b={};return angular.forEach(a,function(a,c){a&&"gems"!==c&&"other"!==c&&(b[c]=a)}),b},a.extractSenses=function(a){var b=[];return angular.forEach(a,function(a){(a.name.match(/darkvision/i)||a.name.match(/low-?light vision/i)||a.name.match(/true seeing/i))&&b.push(a)}),b},a.saveComment=function(){a.character.comments||(a.character.comments=[]),a.comment.modified=new Date,a.character.comments.push(a.comment),a.comment={author:a.comment.author},a.character.modified=new Date,a.character.saveOrUpdate()},a.deleteComment=function(b){if("Delete"===b.deleteButtonText)b.deleteButtonText="Confirm?";else{var c=a.character.comments.indexOf(b);c>-1&&(a.character.comments.splice(c,1),a.character.modified=new Date,a.character.saveOrUpdate())}}}]),angular.module("sheetApp").factory("Character",["$resource",function(a){function b(){var b=a("/api/v1/characters/:id",{id:"@_id"},{update:{method:"PUT"}});return b.getById=function(a,c,d){return b.get({id:a},c,d)},b.prototype.update=function(a,c){return b.update({id:this._id},angular.extend({},this,{_id:void 0}),a,c)},b.prototype.saveOrUpdate=function(a,b,c,d){return this._id?this.update(b,d):this.$save(a,c)},b.prototype.remove=function(a,c){return b.remove({id:this._id},a,c)},b.prototype["delete"]=function(a,b){return this.remove(a,b)},b._id&&(b.resourceUrl="/api/v1/characters/"+b._id),b}return new b}]),angular.module("sheetApp").directive("abilityModifier",function(){return{templateUrl:"views/directives/abilityModifier.html",scope:{ability:"@",score:"=",tempScore:"=",show:"@",label:"@",nolabel:"@"},restrict:"E",link:function(a,b,c){var d,e=!1;"score"===c.show?(d="score",a.temp=!1):"temp"===c.show?(d="tempScore",a.temp=!0):(d="[score,tempScore]",e=!0),a.$watch(d,function(b){e&&(b=b[1]?b[1]:b[0]);var c=Math.floor((parseInt(b,10)-10)/2);c>=0&&(c="+"+c),a.modifier=c||""},e)}}}),angular.module("sheetApp").directive("autoComplete",["$timeout","$filter",function(a,b){return{templateUrl:"views/directives/autoComplete.html",scope:{values:"=",model:"="},restrict:"E",link:function(a,c){var d=c.find("input");a.showSuggestions=!1,a.fromSelect=!1,a.$watch("model",function(c){c&&!a.fromSelect&&d.hasClass("ng-dirty")?(a.showSuggestions=!0,a.suggestions=b("filter")(a.values,a.model).slice(0,25)):a.fromSelect&&(a.fromSelect=!1)}),a.select=function(b,c){c?(13===c.keyCode||32===c.keyCode)&&(a.model=b,a.showSuggestions=!1,a.fromSelect=!0):(a.model=b,a.showSuggestions=!1,a.fromSelect=!0)}}}}]);